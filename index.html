<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MR.js Lava Floor Experience</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            color: #fff;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }

```
    #info {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 100;
        background: rgba(0,0,0,0.7);
        padding: 15px;
        border-radius: 8px;
        border: 2px solid #ff4444;
        max-width: 300px;
    }
    
    #controls {
        position: absolute;
        bottom: 20px;
        left: 20px;
        z-index: 100;
        background: rgba(0,0,0,0.8);
        padding: 15px;
        border-radius: 8px;
        border: 2px solid #ff6600;
    }
    
    button {
        background: linear-gradient(45deg, #ff4444, #ff6600);
        color: white;
        border: none;
        padding: 10px 20px;
        margin: 5px;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s ease;
    }
    
    button:hover {
        background: linear-gradient(45deg, #ff6600, #ff8800);
        transform: scale(1.05);
    }
    
    #canvas-container {
        width: 100vw;
        height: 100vh;
        position: relative;
    }
    
    .status {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        z-index: 50;
        background: rgba(0,0,0,0.8);
        padding: 20px;
        border-radius: 10px;
        border: 2px solid #ff4444;
    }
</style>
```

</head>
<body>
    <div id="info">
        <h3>ðŸ”¥ MR.js Lava Floor Experience</h3>
        <p>Mixed Reality prototype with lava shader on floor plane</p>
        <p><strong>Features:</strong></p>
        <ul>
            <li>âœ¨ Spatial floor anchoring</li>
            <li>ðŸŒ‹ Animated lava shader</li>
            <li>ðŸ¥½ VR/MR co-location ready</li>
            <li>ðŸŽ® Hand tracking support</li>
        </ul>
    </div>

```
<div id="controls">
    <button onclick="toggleMR()">Enter MR Mode</button>
    <button onclick="toggleVR()">Enter VR Mode</button>
    <button onclick="resetFloor()">Reset Floor</button>
    <button onclick="toggleLava()">Toggle Lava</button>
</div>

<div id="canvas-container">
    <canvas id="mrCanvas"></canvas>
</div>

<div id="status" class="status" style="display: none;">
    <h3>Initializing Mixed Reality...</h3>
    <p>Setting up spatial anchors and lava shader</p>
</div>

<script>
    // Global variables
    let scene, camera, renderer, mrSession, vrSession;
    let lavaFloor, lavaShader;
    let spatialAnchor = null;
    let handControllers = [];
    let isLavaActive = true;
    let floorGeometry, floorMesh;
    
    // Initialize the experience
    init();
    animate();
    
    function init() {
        // Create scene
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x000510);
        
        // Create camera
        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 1.6, 3);
        
        // Create renderer with XR support
        const canvas = document.getElementById('mrCanvas');
        renderer = new THREE.WebGLRenderer({ 
            canvas: canvas,
            antialias: true,
            alpha: true 
        });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.xr.enabled = true;
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        
        // Create lava shader material
        createLavaShader();
        
        // Create floor with lava shader
        createLavaFloor();
        
        // Add ambient lighting
        const ambientLight = new THREE.AmbientLight(0x404040, 0.3);
        scene.add(ambientLight);
        
        // Add directional light
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(5, 10, 5);
        directionalLight.castShadow = true;
        directionalLight.shadow.mapSize.width = 2048;
        directionalLight.shadow.mapSize.height = 2048;
        scene.add(directionalLight);
        
        // Add some floating lava orbs for effect
        createLavaOrbs();
        
        // Add environment elements
        createEnvironmentElements();
        
        // Setup hand tracking and controllers
        setupHandTracking();
        
        // Handle window resize
        window.addEventListener('resize', onWindowResize, false);
        
        console.log('ðŸ”¥ MR.js Lava Floor Experience initialized');
    }
    
    function createLavaShader() {
        // Custom lava shader with animated noise
        const vertexShader = `
            varying vec2 vUv;
            varying vec3 vPosition;
            uniform float time;
            
            void main() {
                vUv = uv;
                vPosition = position;
                
                // Add some subtle vertex displacement for lava bubbling
                vec3 pos = position;
                pos.y += sin(pos.x * 4.0 + time * 2.0) * 0.02;
                pos.y += sin(pos.z * 3.0 + time * 1.5) * 0.015;
                
                gl_Position = projectionMatrix * modelViewMatrix * vec4(pos, 1.0);
            }
        `;
        
        const fragmentShader = `
            uniform float time;
            uniform vec3 color1;
            uniform vec3 color2;
            uniform vec3 color3;
            varying vec2 vUv;
            varying vec3 vPosition;
            
            // Noise function
            float noise(vec2 p) {
                return fract(sin(dot(p, vec2(12.9898, 78.233))) * 43758.5453);
            }
            
            float smoothNoise(vec2 p) {
                vec2 i = floor(p);
                vec2 f = fract(p);
                f = f * f * (3.0 - 2.0 * f);
                
                float a = noise(i);
                float b = noise(i + vec2(1.0, 0.0));
                float c = noise(i + vec2(0.0, 1.0));
                float d = noise(i + vec2(1.0, 1.0));
                
                return mix(mix(a, b, f.x), mix(c, d, f.x), f.y);
            }
            
            void main() {
                vec2 uv = vUv * 8.0;
                
                // Animated noise layers
                float noise1 = smoothNoise(uv + time * 0.5);
                float noise2 = smoothNoise(uv * 2.0 + time * 0.3);
                float noise3 = smoothNoise(uv * 4.0 - time * 0.2);
                
                // Combine noise layers
                float combined = noise1 * 0.5 + noise2 * 0.3 + noise3 * 0.2;
                
                // Create lava flow pattern
                float flow = sin(vUv.x * 10.0 + time) * 0.1 + sin(vUv.y * 15.0 + time * 0.7) * 0.1;
                combined += flow;
                
                // Map to lava colors
                vec3 lavaColor;
                if (combined < 0.3) {
                    lavaColor = mix(color1, color2, combined / 0.3);
                } else if (combined < 0.7) {
                    lavaColor = mix(color2, color3, (combined - 0.3) / 0.4);
                } else {
                    lavaColor = mix(color3, vec3(1.0, 1.0, 0.8), (combined - 0.7) / 0.3);
                }
                
                // Add glow effect
                float glow = smoothstep(0.4, 0.8, combined);
                lavaColor += glow * 0.3;
                
                gl_FragColor = vec4(lavaColor, 1.0);
            }
        `;
        
        lavaShader = new THREE.ShaderMaterial({
            vertexShader: vertexShader,
            fragmentShader: fragmentShader,
            uniforms: {
                time: { value: 0.0 },
                color1: { value: new THREE.Color(0x330000) }, // Dark red
                color2: { value: new THREE.Color(0xaa1100) }, // Red
                color3: { value: new THREE.Color(0xff4400) }  // Orange-red
            }
        });
    }
    
    function createLavaFloor() {
        // Create floor geometry (represents the scanned/anchored floor)
        floorGeometry = new THREE.PlaneGeometry(20, 20, 64, 64);
        floorMesh = new THREE.Mesh(floorGeometry, lavaShader);
        floorMesh.rotation.x = -Math.PI / 2; // Rotate to be horizontal
        floorMesh.position.y = 0; // Floor level
        floorMesh.receiveShadow = true;
        scene.add(floorMesh);
        
        lavaFloor = floorMesh;
    }
    
    function createLavaOrbs() {
        // Create floating lava orbs
        for (let i = 0; i < 15; i++) {
            const orbGeometry = new THREE.SphereGeometry(0.1 + Math.random() * 0.1, 16, 16);
            const orbMaterial = new THREE.MeshBasicMaterial({
                color: new THREE.Color().setHSL(0.05 + Math.random() * 0.1, 1, 0.5 + Math.random() * 0.3),
                transparent: true,
                opacity: 0.8
            });
            
            const orb = new THREE.Mesh(orbGeometry, orbMaterial);
            orb.position.set(
                (Math.random() - 0.5) * 15,
                0.2 + Math.random() * 2,
                (Math.random() - 0.5) * 15
            );
            
            // Add floating animation
            orb.userData = {
                originalY: orb.position.y,
                floatSpeed: 0.5 + Math.random() * 1.0,
                floatRange: 0.3 + Math.random() * 0.2
            };
            
            scene.add(orb);
        }
    }
    
    function createEnvironmentElements() {
        // Add some rock formations
        for (let i = 0; i < 8; i++) {
            const rockGeometry = new THREE.BoxGeometry(
                0.5 + Math.random() * 1.5,
                0.3 + Math.random() * 0.8,
                0.5 + Math.random() * 1.5
            );
            const rockMaterial = new THREE.MeshLambertMaterial({
                color: new THREE.Color(0x333333)
            });
            
            const rock = new THREE.Mesh(rockGeometry, rockMaterial);
            rock.position.set(
                (Math.random() - 0.5) * 18,
                0.2,
                (Math.random() - 0.5) * 18
            );
            rock.rotation.y = Math.random() * Math.PI * 2;
            rock.castShadow = true;
            rock.receiveShadow = true;
            scene.add(rock);
        }
    }
    
    function setupHandTracking() {
        // Placeholder for hand tracking setup
        // In a real MR.js implementation, this would connect to WebXR hand tracking
        console.log('ðŸ¤š Hand tracking setup (placeholder)');
    }
    
    function animate() {
        renderer.setAnimationLoop(render);
    }
    
    function render() {
        const time = performance.now() * 0.001;
        
        // Update lava shader
        if (lavaShader && isLavaActive) {
            lavaShader.uniforms.time.value = time;
        }
        
        // Animate floating orbs
        scene.children.forEach(child => {
            if (child.userData && child.userData.originalY !== undefined) {
                child.position.y = child.userData.originalY + 
                    Math.sin(time * child.userData.floatSpeed) * child.userData.floatRange;
            }
        });
        
        // Render the scene
        renderer.render(scene, camera);
    }
    
    // MR/VR Control Functions
    async function toggleMR() {
        if (!navigator.xr) {
            alert('WebXR not supported in this browser');
            return;
        }
        
        try {
            const supported = await navigator.xr.isSessionSupported('immersive-ar');
            if (!supported) {
                alert('AR not supported on this device');
                return;
            }
            
            if (mrSession) {
                mrSession.end();
                mrSession = null;
            } else {
                showStatus('Entering Mixed Reality Mode...');
                mrSession = await navigator.xr.requestSession('immersive-ar', {
                    requiredFeatures: ['local-floor', 'bounded-floor'],
                    optionalFeatures: ['hand-tracking', 'anchors']
                });
                
                await renderer.xr.setSession(mrSession);
                
                // Setup spatial anchors for floor tracking
                setupSpatialAnchors();
                hideStatus();
            }
        } catch (error) {
            console.error('MR session error:', error);
            alert('Could not start MR session: ' + error.message);
        }
    }
    
    async function toggleVR() {
        if (!navigator.xr) {
            alert('WebXR not supported in this browser');
            return;
        }
        
        try {
            const supported = await navigator.xr.isSessionSupported('immersive-vr');
            if (!supported) {
                alert('VR not supported on this device');
                return;
            }
            
            if (vrSession) {
                vrSession.end();
                vrSession = null;
            } else {
                showStatus('Entering Virtual Reality Mode...');
                vrSession = await navigator.xr.requestSession('immersive-vr', {
                    requiredFeatures: ['local-floor'],
                    optionalFeatures: ['hand-tracking']
                });
                
                await renderer.xr.setSession(vrSession);
                hideStatus();
            }
        } catch (error) {
            console.error('VR session error:', error);
            alert('Could not start VR session: ' + error.message);
        }
    }
    
    function setupSpatialAnchors() {
        // Placeholder for spatial anchor setup
        // In a real implementation, this would use WebXR anchors API
        console.log('ðŸ”— Setting up spatial anchors for floor tracking');
        
        // Simulate floor detection and anchoring
        setTimeout(() => {
            console.log('âœ… Floor anchor established');
            // Adjust floor position based on detected floor
            if (lavaFloor) {
                lavaFloor.position.y = 0; // Adjust to detected floor level
            }
        }, 1000);
    }
    
    function resetFloor() {
        if (lavaFloor) {
            lavaFloor.position.set(0, 0, 0);
            lavaFloor.rotation.x = -Math.PI / 2;
            console.log('ðŸ”„ Floor reset to origin');
        }
    }
    
    function toggleLava() {
        isLavaActive = !isLavaActive;
        
        if (isLavaActive) {
            lavaFloor.material = lavaShader;
            console.log('ðŸŒ‹ Lava shader enabled');
        } else {
            const basicMaterial = new THREE.MeshLambertMaterial({ color: 0x666666 });
            lavaFloor.material = basicMaterial;
            console.log('âš« Lava shader disabled');
        }
    }
    
    function showStatus(message) {
        const status = document.getElementById('status');
        status.innerHTML = `<h3>${message}</h3>`;
        status.style.display = 'block';
    }
    
    function hideStatus() {
        const status = document.getElementById('status');
        status.style.display = 'none';
    }
    
    function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    }
    
    // Cleanup
    window.addEventListener('beforeunload', () => {
        if (mrSession) mrSession.end();
        if (vrSession) vrSession.end();
    });
    
    console.log('ðŸš€ MR.js Lava Floor Experience ready!');
</script>
```

</body>
</html>
